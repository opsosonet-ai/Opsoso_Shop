<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">Th√™m m·ªõi tr·∫£ h√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 80px;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }
        .form-label {
            font-weight: 500;
        }
        .required::after {
            content: " *";
            color: #dc3545;
        }
        #customer-suggestions {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-chart-line me-2"></i>OSS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>T·ªïng quan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/nhan-vien">
                            <i class="fas fa-users me-1"></i>Nh√¢n vi√™n
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/hang-hoa">
                            <i class="fas fa-box me-1"></i>H√†ng h√≥a
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/khach-hang">
                            <i class="fas fa-user-friends me-1"></i>Kh√°ch h√†ng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/nha-phan-phoi">
                            <i class="fas fa-truck me-1"></i>Nh√† ph√¢n ph·ªëi
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">
                            <i class="fas fa-cog me-1"></i>C√†i ƒë·∫∑t
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>Ng∆∞·ªùi d√πng
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/auth/change-password">
                                <i class="fas fa-key me-2"></i>ƒê·ªïi m·∫≠t kh·∫©u
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/auth/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/tra-hang">Tr·∫£ h√†ng</a></li>
                        <li class="breadcrumb-item active">Th√™m m·ªõi</li>
                    </ol>
                </nav>
                <h2>
                    <i class="fas fa-plus text-primary me-2"></i>
                    Th√™m m·ªõi tr·∫£ h√†ng
                </h2>
            </div>
            <div class="col-md-4 text-end">
                <a href="/tra-hang" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Quay l·∫°i
                </a>
            </div>
        </div>

        <!-- Alert Messages -->
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-form me-2"></i>Th√¥ng tin tr·∫£ h√†ng
                </h5>
            </div>
            <div class="card-body">
                <form id="traHangForm" th:action="@{/tra-hang/them}" th:object="${traHang}" method="post" onsubmit="return handleFormSubmit(event)">
                    <!-- Hidden field for maTraHang - will be generated server-side, not user input -->
                    <input type="hidden" id="maTraHang" th:field="*{maTraHang}">
                    
                    <!-- Step 1: Search Invoice & Return Date -->
                    <div class="row">
                        <!-- Search Invoice (Left) -->
                        <div class="col-md-6 mb-3">
                            <label for="phieuXuatSearch" class="form-label required">T√¨m ki·∫øm phi·∫øu xu·∫•t</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="phieuXuatSearch" 
                                       placeholder="Nh·∫≠p m√£ phi·∫øu xu·∫•t ho·∫∑c t√™n kh√°ch h√†ng..." autocomplete="off">
                                <div id="phieu-xuat-suggestions" class="list-group" style="display: none; position: absolute; z-index: 1000; width: 100%; max-height: 250px; overflow-y: auto;"></div>
                            </div>
                            <small class="text-muted">T√¨m ki·∫øm phi·∫øu xu·∫•t theo m√£ ho·∫∑c t√™n kh√°ch h√†ng</small>
                        </div>

                        <!-- Return Date (Right) -->
                        <div class="col-md-6 mb-3">
                            <label for="ngayTraHang" class="form-label">Ng√†y tr·∫£ h√†ng</label>
                            <input type="date" class="form-control" id="ngayTraHang" 
                                   th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" readonly>
                        </div>

                    <!-- Step 2: Select Products from Invoice -->
                    <div class="mb-4">
                        <label class="form-label required">H√†ng h√≥a t·ª´ phi·∫øu xu·∫•t</label>
                        <div id="products-list-container" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 30%">H√†ng h√≥a</th>
                                            <th style="width: 15%">M√£</th>
                                            <th style="width: 15%">ƒê√£ b√°n</th>
                                            <th style="width: 15%">ƒê∆°n gi√°</th>
                                            <th style="width: 15%">Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="products-list-body">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <small class="text-muted" id="phieu-xuat-product-hint">Nh·∫•p v√†o h√†ng h√≥a ƒë·ªÉ th√™m v√†o danh s√°ch tr·∫£</small>
                        </div>
                        <div id="products-empty-message" class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> Ch·ªçn phi·∫øu xu·∫•t tr√™n ƒë·ªÉ xem danh s√°ch h√†ng h√≥a</small>
                        </div>
                    </div>

                    <!-- Selected Products for Return -->
                    <div class="mb-4">
                        <label class="form-label required">H√†ng h√≥a c·∫ßn tr·∫£ l·∫°i</label>
                        <div id="selected-products-container">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 35%">H√†ng h√≥a</th>
                                            <th style="width: 12%">M√£</th>
                                            <th style="width: 12%">ƒê∆°n gi√°</th>
                                            <th style="width: 12%">S·ªë l∆∞·ª£ng</th>
                                            <th style="width: 15%">Th√†nh ti·ªÅn</th>
                                            <th style="width: 14%">Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="selected-products-body">
                                        <tr class="text-center text-muted">
                                            <td colspan="6"><small>Ch∆∞a ch·ªçn h√†ng h√≥a n√†o</small></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Total Summary -->
                        <div class="row mt-3">
                            <div class="col-md-6 offset-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-8">
                                                <strong>T·ªïng c·ªông:</strong>
                                            </div>
                                            <div class="col-4 text-end">
                                                <strong id="total-amount">0 VNƒê</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tr·∫°ng th√°i -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="trangThai" class="form-label">Tr·∫°ng th√°i</label>
                            <select class="form-select" id="trangThai" th:field="*{trangThai}">
                                <option th:each="trangThai : ${danhSachTrangThai}" 
                                        th:value="${trangThai}" 
                                        th:text="${trangThai.displayName}"
                                        th:selected="${trangThai.name() == 'CHO_DUYET'}">
                                    Tr·∫°ng th√°i
                                </option>
                            </select>
                        </div>
                    </div>

                    <hr>
                    <h6><i class="fas fa-user me-2"></i>Th√¥ng tin kh√°ch h√†ng</h6>

                    <div class="row">
                        <!-- T√™n kh√°ch h√†ng -->
                        <div class="col-md-6 mb-3">
                            <label for="tenKhachHang" class="form-label required">T√™n kh√°ch h√†ng</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="tenKhachHang" th:field="*{tenKhachHang}" 
                                       required autocomplete="off" placeholder="Nh·∫≠p t√™n ho·∫∑c t√¨m ki·∫øm kh√°ch h√†ng...">
                                <div id="customer-suggestions" class="list-group" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- S·ªë ƒëi·ªán tho·∫°i -->
                        <div class="col-md-6 mb-3">
                            <label for="soDienThoai" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" class="form-control" id="soDienThoai" th:field="*{soDienThoai}" 
                                   placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
                        </div>
                    </div>

                    <!-- L√Ω do tr·∫£ h√†ng -->
                    <div class="mb-3">
                        <label for="lyDo" class="form-label">L√Ω do tr·∫£ h√†ng</label>
                        <textarea class="form-control" id="lyDo" th:field="*{lyDo}" rows="3" 
                                  placeholder="Nh·∫≠p l√Ω do tr·∫£ h√†ng..."></textarea>
                    </div>

                    <!-- Hidden inputs for selected products -->
                    <div id="selected-products-inputs"></div>

                    <div class="text-end">
                        <a href="/tra-hang" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-1"></i>H·ªßy
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>L∆∞u tr·∫£ h√†ng
                        </button>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store all invoices data globally
        let allPhieuXuatData = [];
        let selectedPhieuXuatId = null;
        let phieuSearchTimeout;
        let phieuXuatSearchInput;
        let phieuXuatSuggestions;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DOM elements
            phieuXuatSearchInput = document.getElementById('phieuXuatSearch');
            phieuXuatSuggestions = document.getElementById('phieu-xuat-suggestions');

            // Attach event listeners for suggestions
            attachSuggestionListeners();

            // Add event listener for search input
            loadAllInvoices();
            if (phieuXuatSearchInput) {
                phieuXuatSearchInput.addEventListener('input', function() {
                    clearTimeout(phieuSearchTimeout);
                    const query = this.value.trim().toLowerCase();
                    
                    if (query.length < 1) {
                        phieuXuatSuggestions.style.display = 'none';
                        return;
                    }

                    phieuSearchTimeout = setTimeout(function() {
                        searchInvoices(query);
                    }, 300);
                });
            }
        });

        // Load all invoices from API
        function loadAllInvoices() {
            console.log('üì• Loading all invoices...');
            fetch('/tra-hang/api/all-phieu-xuat')
                .then(response => {
                    console.log('üì° API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    allPhieuXuatData = data;
                    console.log('‚úÖ Loaded invoices:', allPhieuXuatData.length, 'items');
                })
                .catch(error => {
                    console.error('‚ùå Error loading invoices:', error);
                });
        }

        function searchInvoices(query) {
            const filtered = allPhieuXuatData.filter(phieu => {
                const maPhieu = (phieu.maPhieuXuat || '').toLowerCase();
                const tenKhach = (phieu.khachHang?.hoTen || '').toLowerCase();
                const sdtKhach = (phieu.khachHang?.soDienThoai || '').toLowerCase();
                
                return maPhieu.includes(query) || tenKhach.includes(query) || sdtKhach.includes(query);
            });

            displayInvoiceSuggestions(filtered);
        }

        function displayInvoiceSuggestions(invoices) {
            phieuXuatSuggestions.innerHTML = '';
            
            if (invoices.length === 0) {
                phieuXuatSuggestions.style.display = 'none';
                return;
            }

            invoices.forEach((invoice) => {
                const item = document.createElement('div');
                item.className = 'list-group-item suggestion-item';
                item.style.padding = '10px 12px';
                item.style.cursor = 'pointer';
                item.setAttribute('data-invoice-id', invoice.id);
                // Store the actual invoice object in data attribute for direct access
                item.setAttribute('data-invoice-data', JSON.stringify(invoice));
                item.innerHTML = `
                    <div>
                        <strong>${invoice.maPhieuXuat}</strong>
                        <small class="text-muted ms-2">${invoice.ngayXuat ? new Date(invoice.ngayXuat).toLocaleDateString('vi-VN') : 'N/A'}</small>
                    </div>
                    <small class="text-muted">
                        ${invoice.khachHang?.hoTen || 'N/A'} 
                        ${invoice.khachHang?.soDienThoai ? ' - ' + invoice.khachHang.soDienThoai : ''}
                    </small>
                `;
                
                phieuXuatSuggestions.appendChild(item);
            });
            
            phieuXuatSuggestions.style.display = 'block';
            console.log('‚úÖ Displayed', invoices.length, 'suggestions');
        }

        // Event delegation for suggestion items - moved outside displayInvoiceSuggestions
        // to ensure it only needs to be attached once
        function attachSuggestionListeners() {
            if (!phieuXuatSuggestions) return;
            
            phieuXuatSuggestions.addEventListener('click', function(event) {
                const item = event.target.closest('.suggestion-item');
                if (!item) return;
                
                // Get invoice data stored in the data attribute
                const invoiceDataStr = item.getAttribute('data-invoice-data');
                if (invoiceDataStr) {
                    try {
                        const invoice = JSON.parse(invoiceDataStr);
                        console.log('üîç Item clicked, selecting invoice:', invoice);
                        selectInvoice(invoice);
                    } catch (e) {
                        console.error('‚ùå Failed to parse invoice data:', e);
                    }
                }
            });
        }

        function selectInvoice(invoice) {
            console.log('üîê selectInvoice called with:', invoice);
            selectedPhieuXuatId = invoice.id;
            phieuXuatSearchInput.value = invoice.maPhieuXuat;
            phieuXuatSuggestions.style.display = 'none';

            // RESET selected products when new invoice is selected
            selectedProductsData = [];
            console.log('üîÑ Reset selectedProductsData to empty array');
            
            // Clear selected products display immediately
            const selectedProductsBody = document.getElementById('selected-products-body');
            if (selectedProductsBody) {
                selectedProductsBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6"><small>Ch∆∞a ch·ªçn h√†ng h√≥a n√†o</small></td></tr>';
                console.log('üîÑ Cleared selected products display');
            }

            // Reset products table to show loading state
            const productsListBody = document.getElementById('products-list-body');
            const productsListContainer = document.getElementById('products-list-container');
            const productsEmptyMessage = document.getElementById('products-empty-message');
            
            if (productsListBody && productsListContainer && productsEmptyMessage) {
                productsListBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><small>ƒêang t·∫£i h√†ng h√≥a...</small></td></tr>';
                productsListContainer.style.display = 'block';
                productsEmptyMessage.style.display = 'none';
                console.log('üì¶ Showing loading state for products list');
            }

            // Load products for this invoice
            loadProductsForInvoice(invoice.id, invoice);
        }

        // Store selected products globally
        let selectedProductsData = [];
        let currentLoadingInvoiceId = null; // Track which invoice is currently loading

        function loadProductsForInvoice(invoiceId, invoiceData) {
            console.log('üîç Loading products for invoice ID:', invoiceId);
            console.log('‚è±Ô∏è Current time:', new Date().toLocaleTimeString());
            
            // Set current loading invoice ID to prevent race conditions
            currentLoadingInvoiceId = invoiceId;
            console.log('üîÑ currentLoadingInvoiceId set to:', currentLoadingInvoiceId);
            
            // Create timeout controller
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            fetch(`/tra-hang/api/phieu-xuat/${invoiceId}/chi-tiet`, { signal: controller.signal })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('üì° API Response status:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(details => {
                    console.log('‚úÖ API Response data received at:', new Date().toLocaleTimeString());
                    console.log('‚úÖ API Response data:', details);
                    console.log('üìä Number of products:', Array.isArray(details) ? details.length : 'Not an array');
                    
                    // Only update if this is still the current invoice being loaded
                    if (currentLoadingInvoiceId !== invoiceId) {
                        console.warn('‚ö†Ô∏è  Ignoring response for invoice', invoiceId, 'because currentLoadingInvoiceId is', currentLoadingInvoiceId);
                        return;
                    }
                    
                    if (Array.isArray(details) && details.length > 0) {
                        console.log('üéØ First product structure:', JSON.stringify(details[0], null, 2));
                    }
                    
                    console.log('üìù Calling populateProductsList with', details.length, 'products');
                    populateProductsList(details, invoiceData);
                    
                    // Auto-fill customer info
                    if (invoiceData.khachHang) {
                        document.getElementById('tenKhachHang').value = invoiceData.khachHang.hoTen || '';
                        document.getElementById('soDienThoai').value = invoiceData.khachHang.soDienThoai || '';
                    }
                    
                    console.log('‚úÖ Products loaded and displayed successfully');
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('‚ùå Error loading products:', error);
                    console.error('‚ùå Error name:', error.name);
                    console.error('‚ùå Error message:', error.message);
                    
                    // Show more helpful error message
                    if (error.name === 'AbortError') {
                        alert('L·ªói: Request qu√° l√¢u. Vui l√≤ng th·ª≠ l·∫°i.');
                    } else {
                        alert('L·ªói t·∫£i danh s√°ch h√†ng h√≥a: ' + error.message);
                    }
                });
        }

        function populateProductsList(details, invoiceData) {
            console.log('üõ†Ô∏è populateProductsList called with:', {details: details ? details.length : 0, invoiceData: invoiceData ? 'yes' : 'no'});
            
            if (!Array.isArray(details)) {
                console.error('‚ùå Details is not an array:', typeof details, details);
                alert('L·ªói: D·ªØ li·ªáu h√†ng h√≥a kh√¥ng h·ª£p l·ªá');
                return;
            }
            
            const productsListBody = document.getElementById('products-list-body');
            const productsListContainer = document.getElementById('products-list-container');
            const productsEmptyMessage = document.getElementById('products-empty-message');
            
            if (!productsListBody) {
                console.error('‚ùå Cannot find products list body');
                return;
            }
            
            console.log('üîç DOM elements found:', {
                productsListBody: !!productsListBody,
                productsListContainer: !!productsListContainer,
                productsEmptyMessage: !!productsEmptyMessage
            });
            
            // Clear previous products
            productsListBody.innerHTML = '';
            console.log('‚úÖ Cleared products list body, innerHTML length:', productsListBody.innerHTML.length);
            
            if (details.length === 0) {
                console.log('‚ö†Ô∏è  No products found (details.length = 0), showing empty message');
                if (productsEmptyMessage) {
                    productsEmptyMessage.style.display = 'block';
                }
                if (productsListContainer) {
                    productsListContainer.style.display = 'none';
                }
                console.log('üìã Final visibility - Empty message display:', productsEmptyMessage?.style.display, 'Container display:', productsListContainer?.style.display);
                return;
            }
            
            // Show products table
            console.log('üìä Found', details.length, 'products, showing table');
            if (productsEmptyMessage) {
                productsEmptyMessage.style.display = 'none';
            }
            if (productsListContainer) {
                productsListContainer.style.display = 'block';
            }
            console.log('üìã Set visibility - Empty message display: none, Container display: block');
            
            const hintEl = document.getElementById('phieu-xuat-product-hint');
            if (hintEl) {
                hintEl.textContent = `${details.length} h√†ng h√≥a c√≥ s·∫µn - Nh·∫•p "Th√™m" ƒë·ªÉ ch·ªçn h√†ng h√≥a`;
                console.log('‚úÖ Updated product hint text');
            }
            
            let addedCount = 0;
            details.forEach((detail, index) => {
                try {
                    if (!detail.hangHoa) {
                        console.warn(`‚ö†Ô∏è  Product ${index} has no hangHoa object:`, detail);
                        return; // Skip this item
                    }
                    
                    const row = document.createElement('tr');
                    const hangHoa = detail.hangHoa;
                    const soLuong = detail.soLuong || 0;
                    const donGia = detail.donGia || 0;
                    
                    row.innerHTML = `
                        <td>
                            <strong>${hangHoa.tenHangHoa || 'N/A'}</strong>
                            <br>
                            <small class="text-muted">T·ªëi ƒëa: ${soLuong} c√°i</small>
                        </td>
                        <td><code>${hangHoa.maHangHoa || 'N/A'}</code></td>
                        <td><small>${soLuong}</small></td>
                        <td><small>${donGia.toLocaleString('vi-VN')} VNƒê</small></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="addProductToReturn('${hangHoa.id}', '${hangHoa.tenHangHoa}', '${hangHoa.maHangHoa}', '${donGia}', '${soLuong}')">
                                <i class="fas fa-plus"></i> Th√™m
                            </button>
                        </td>
                    `;
                    
                    productsListBody.appendChild(row);
                    addedCount++;
                    console.log(`‚úÖ Added product ${addedCount}/${details.length}: ${hangHoa.tenHangHoa}`);
                } catch (err) {
                    console.error(`‚ùå Error processing product ${index}:`, err, detail);
                }
            });
            
            console.log(`‚úÖ‚úÖ‚úÖ FINAL: Populated ${addedCount} products in table (${details.length} expected)`);
            console.log('üîç Final table body innerHTML length:', productsListBody.innerHTML.length);
            console.log('üîç Final container display:', productsListContainer.style.display);
        }

        function addProductToReturn(hangHoaId, tenHangHoa, maHangHoa, donGia, maxQty) {
            console.log('‚ûï Adding product to return:', {hangHoaId, tenHangHoa, maHangHoa, donGia, maxQty});
            
            // Check if product already added
            if (selectedProductsData.find(p => p.hangHoaId == hangHoaId)) {
                alert(`${tenHangHoa} ƒë√£ ƒë∆∞·ª£c th√™m v√†o danh s√°ch!`);
                return;
            }
            
            // Prompt user for quantity
            const quantity = prompt(`Nh·∫≠p s·ªë l∆∞·ª£ng c·∫ßn tr·∫£ c·ªßa "${tenHangHoa}" (t·ªëi ƒëa ${maxQty}):`, '1');
            
            if (quantity === null) {
                return; // User cancelled
            }
            
            const qty = parseInt(quantity);
            if (isNaN(qty) || qty <= 0 || qty > maxQty) {
                alert(`S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p t·ª´ 1 ƒë·∫øn ${maxQty}`);
                return;
            }
            
            // Add product to selected list
            const product = {
                hangHoaId: hangHoaId,
                tenHangHoa: tenHangHoa,
                maHangHoa: maHangHoa,
                donGia: parseFloat(donGia),
                soLuong: qty,
                thanhTien: parseFloat(donGia) * qty
            };
            
            selectedProductsData.push(product);
            console.log('‚úÖ Product added. Current selection:', selectedProductsData);
            
            // Update display
            displaySelectedProducts();
            updateTotalAmount();
        }

        function displaySelectedProducts() {
            const selectedProductsBody = document.getElementById('selected-products-body');
            
            if (selectedProductsData.length === 0) {
                selectedProductsBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6"><small>Ch∆∞a ch·ªçn h√†ng h√≥a n√†o</small></td></tr>';
                return;
            }
            
            selectedProductsBody.innerHTML = '';
            
            selectedProductsData.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${product.tenHangHoa}</strong></td>
                    <td><code>${product.maHangHoa}</code></td>
                    <td>${product.donGia.toLocaleString('vi-VN')} VNƒê</td>
                    <td>
                        <input type="number" class="form-control form-control-sm" 
                               value="${product.soLuong}" min="1" max="999"
                               onchange="updateProductQuantity(${index}, this.value)">
                    </td>
                    <td>${product.thanhTien.toLocaleString('vi-VN')} VNƒê</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger"
                                onclick="removeProduct(${index})">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </td>
                `;
                
                selectedProductsBody.appendChild(row);
            });
        }

        function updateProductQuantity(index, newQty) {
            const qty = parseInt(newQty);
            if (isNaN(qty) || qty <= 0) {
                alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá');
                displaySelectedProducts();
                return;
            }
            
            selectedProductsData[index].soLuong = qty;
            selectedProductsData[index].thanhTien = selectedProductsData[index].donGia * qty;
            
            console.log('‚úÖ Updated product quantity at index', index, selectedProductsData[index]);
            
            displaySelectedProducts();
            updateTotalAmount();
        }

        function removeProduct(index) {
            const product = selectedProductsData[index];
            if (confirm(`X√≥a "${product.tenHangHoa}" kh·ªèi danh s√°ch?`)) {
                selectedProductsData.splice(index, 1);
                console.log('‚úÖ Removed product at index', index);
                displaySelectedProducts();
                updateTotalAmount();
            }
        }

        function updateTotalAmount() {
            const total = selectedProductsData.reduce((sum, p) => sum + p.thanhTien, 0);
            document.getElementById('total-amount').textContent = total.toLocaleString('vi-VN') + ' VNƒê';
            console.log('üí∞ Updated total:', total);
        }

        // Update h√†ng h√≥a info when selected
        function updateHangHoaInfo() {
            const select = document.getElementById('hangHoaId');
            const selectedOption = select.options[select.selectedIndex];
            
            // Clear all fields first to avoid residual data
            clearAllFields();
            
            if (selectedOption && selectedOption.value && selectedOption.value !== '') {
                console.log('Selected option:', selectedOption.value);
                
                // C·∫≠p nh·∫≠t gi√°
                const gia = selectedOption.getAttribute('data-gia');
                console.log('Gia:', gia);
                document.getElementById('donGia').value = gia || '';
                
                // C·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng t·ª± ƒë·ªông t·ª´ phi·∫øu xu·∫•t
                const khachHangTen = selectedOption.getAttribute('data-khach-hang-ten');
                const khachHangSdt = selectedOption.getAttribute('data-khach-hang-sdt');
                const soLuongBan = selectedOption.getAttribute('data-so-luong-ban');
                const phieuXuat = selectedOption.getAttribute('data-phieu-xuat');
                
                console.log('Khach hang ten:', khachHangTen);
                console.log('So luong ban:', soLuongBan);
                console.log('Phieu xuat:', phieuXuat);
                
                // Always set quantity limit first
                if (soLuongBan && soLuongBan !== 'null' && soLuongBan !== '' && soLuongBan !== 'NONE') {
                    const soLuongInput = document.getElementById('soLuong');
                    soLuongInput.setAttribute('max', soLuongBan);
                    soLuongInput.value = 1; // Set default value
                    document.getElementById('so-luong-hint').textContent = `T·ªëi ƒëa c√≥ th·ªÉ tr·∫£: ${soLuongBan}`;
                }
                
                // Handle customer information
                if (khachHangTen && khachHangTen !== 'null' && khachHangTen !== '' && khachHangTen !== 'NONE') {
                    document.getElementById('tenKhachHang').value = khachHangTen;
                    
                    // Handle phone number
                    const sdt = khachHangSdt && khachHangSdt !== 'null' && khachHangSdt !== 'NONE' ? khachHangSdt : '';
                    document.getElementById('soDienThoai').value = sdt;
                    
                    // Show additional info
                    if (phieuXuat && soLuongBan) {
                        showHangHoaInfo(phieuXuat, soLuongBan);
                    }
                } else {
                    // N·∫øu kh√¥ng c√≥ th√¥ng tin kh√°ch h√†ng, ƒë·ªÉ tr·ªëng ƒë·ªÉ user t·ª± nh·∫≠p
                    console.log('No customer info available, user needs to input manually');
                    if (phieuXuat && soLuongBan) {
                        showHangHoaInfo(phieuXuat, soLuongBan);
                    }
                }
                
                calculateTotal();
            }
        }
        
        // Clear all form fields
        function clearAllFields() {
            document.getElementById('donGia').value = '';
            document.getElementById('thanhTien').value = '';
            document.getElementById('soLuong').value = '';
            document.getElementById('soLuong').removeAttribute('max');
            document.getElementById('so-luong-hint').textContent = 'Nh·∫≠p s·ªë l∆∞·ª£ng c·∫ßn tr·∫£';
            hideHangHoaInfo();
        }
        
        // Hi·ªÉn th·ªã th√¥ng tin b·ªï sung v·ªÅ phi·∫øu xu·∫•t
        function showHangHoaInfo(phieuXuat, soLuongBan) {
            // Validate input parameters
            if (!phieuXuat || phieuXuat === 'null' || phieuXuat === 'NONE' || 
                !soLuongBan || soLuongBan === 'null' || soLuongBan === 'NONE') {
                console.log('Invalid data for showHangHoaInfo:', phieuXuat, soLuongBan);
                hideHangHoaInfo();
                return;
            }
            
            let infoDiv = document.getElementById('hang-hoa-info');
            if (!infoDiv) {
                infoDiv = document.createElement('div');
                infoDiv.id = 'hang-hoa-info';
                infoDiv.className = 'alert alert-info mt-2';
                const hangHoaSelect = document.getElementById('hangHoaId');
                const parentElement = hangHoaSelect ? hangHoaSelect.parentNode : null;
                if (parentElement) {
                    parentElement.appendChild(infoDiv);
                } else {
                    console.error('Cannot find parent element for info div');
                    return;
                }
            }
            
            if (infoDiv) {
                infoDiv.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Th√¥ng tin mua h√†ng:</strong><br>
                    <small>
                        Phi·∫øu xu·∫•t: <span class="fw-bold text-primary">${phieuXuat}</span> | 
                        S·ªë l∆∞·ª£ng ƒë√£ b√°n: <span class="fw-bold text-success">${soLuongBan}</span>
                    </small>
                `;
                infoDiv.style.display = 'block';
                console.log('Info displayed for:', phieuXuat, soLuongBan);
            }
        }
        
        // ·∫®n th√¥ng tin b·ªï sung
        function hideHangHoaInfo() {
            const infoDiv = document.getElementById('hang-hoa-info');
            if (infoDiv) {
                infoDiv.style.display = 'none';
            }
        }

        // Calculate total amount
        function calculateTotal() {
            const soLuong = parseInt(document.getElementById('soLuong').value) || 0;
            const donGia = parseFloat(document.getElementById('donGia').value) || 0;
            const thanhTien = soLuong * donGia;
            
            document.getElementById('thanhTien').value = thanhTien.toLocaleString('vi-VN');
        }

        // Customer search functionality
        let searchTimeout;
        const customerInput = document.getElementById('tenKhachHang');
        const customerSuggestions = document.getElementById('customer-suggestions');

        customerInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                customerSuggestions.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(function() {
                searchCustomers(query);
            }, 300);
        });

        function searchCustomers(query) {
            fetch(`/tra-hang/api/search-khach-hang?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(customers => {
                    displayCustomerSuggestions(customers);
                })
                .catch(error => {
                    console.error('Error searching customers:', error);
                    customerSuggestions.style.display = 'none';
                });
        }

        function displayCustomerSuggestions(customers) {
            customerSuggestions.innerHTML = '';
            
            if (customers.length === 0) {
                customerSuggestions.style.display = 'none';
                return;
            }

            customers.forEach(customer => {
                const item = document.createElement('div');
                item.className = 'list-group-item suggestion-item';
                item.innerHTML = `
                    <div><strong>${customer.hoTen}</strong></div>
                    <small class="text-muted">${customer.soDienThoai || 'Kh√¥ng c√≥ SƒêT'}</small>
                `;
                
                item.addEventListener('click', function() {
                    customerInput.value = customer.hoTen;
                    document.getElementById('soDienThoai').value = customer.soDienThoai || '';
                    customerSuggestions.style.display = 'none';
                });
                
                customerSuggestions.appendChild(item);
            });
            
            customerSuggestions.style.display = 'block';
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (customerInput && customerSuggestions && !customerInput.contains(event.target) && !customerSuggestions.contains(event.target)) {
                customerSuggestions.style.display = 'none';
            }
            if (phieuXuatSearchInput && phieuXuatSuggestions && !phieuXuatSearchInput.contains(event.target) && !phieuXuatSuggestions.contains(event.target)) {
                phieuXuatSuggestions.style.display = 'none';
            }
        });

        // Auto-hide alerts after 5 seconds
        setTimeout(function() {
            var alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);

        // X·ª≠ l√Ω form submission qua AJAX
        function handleFormSubmit(event) {
            event.preventDefault(); // Prevent default form submission
            
            console.log('üì§ Handling form submission via AJAX...');
            console.log('Selected products:', selectedProductsData);
            
            // Ki·ªÉm tra xem c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn kh√¥ng
            if (selectedProductsData.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ tr·∫£ h√†ng!');
                return false;
            }
            
            // Ki·ªÉm tra th√¥ng tin kh√°ch h√†ng
            const tenKhachHang = document.getElementById('tenKhachHang').value.trim();
            if (!tenKhachHang) {
                alert('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng!');
                return false;
            }
            
            // T·∫°o FormData object t·ª´ form
            const formData = new FormData(document.getElementById('traHangForm'));
            
            // Serialize products to JSON string
            const productsJson = JSON.stringify(selectedProductsData);
            console.log('üì¶ Serialized products JSON:', productsJson);
            
            // Add products JSON as a single parameter
            formData.append('products', productsJson);
            
            // Log all FormData entries for debugging
            console.log('üìã FormData entries:');
            for (let [key, value] of formData.entries()) {
                if (key !== 'products') {
                    console.log(`  ${key}: ${value}`);
                }
            }
            console.log(`  products: ${productsJson}`);
            
            // G·ª≠i AJAX request
            console.log('üöÄ Sending request to /tra-hang/them');
            fetch('/tra-hang/them', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('üì° Response status:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                console.log('‚úÖ Response received, length:', html.length);
                
                // Generate summary of saved codes
                const codeCount = selectedProductsData.length;
                let message = `ƒê√£ t·∫°o ${codeCount} m√£ tr·∫£ h√†ng th√†nh c√¥ng!`;
                
                if (codeCount === 1) {
                    message = `ƒê√£ t·∫°o m√£ tr·∫£ h√†ng th√†nh c√¥ng! Chuy·ªÉn h∆∞·ªõng sau 2 gi√¢y...`;
                } else {
                    message = `ƒê√£ t·∫°o ${codeCount} m√£ tr·∫£ h√†ng th√†nh c√¥ng! Chuy·ªÉn h∆∞·ªõng sau 2 gi√¢y...`;
                }
                
                // Hi·ªÉn th·ªã success message
                showSuccessMessage(message);
                
                // Redirect sau 2 gi√¢y
                setTimeout(() => {
                    window.location.href = '/tra-hang';
                }, 2000);
            })
            .catch(error => {
                console.error('‚ùå Error:', error);
                console.error('‚ùå Error stack:', error.stack);
                showErrorMessage('C√≥ l·ªói x·∫£y ra: ' + error.message);
            });
            
            return false;
        }
        
        // Hi·ªÉn th·ªã success message
        function showSuccessMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container.mt-4');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }, 5000);
        }
        
        // Hi·ªÉn th·ªã error message
        function showErrorMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container.mt-4');
            container.insertBefore(alertDiv, container.firstChild);
        }
    </script>
</body>
</html>
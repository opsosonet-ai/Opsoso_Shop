<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Qu·∫£n l√Ω H√†ng h√≥a</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <style>
            /* Font size cho b·∫£ng h√†ng h√≥a */
            #productTable {
                font-size: 0.8rem;
            }
        
            #productTable thead th {
                font-size: 0.85rem;
                padding: 0.75rem;
            }
        
            #productTable tbody td {
                font-size: 0.8rem;
                padding: 0.6rem 0.75rem;
            }
        </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-chart-line me-2"></i>OSS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link">
                            <i class="fas fa-tachometer-alt me-1"></i>T·ªïng quan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/nhan-vien" class="nav-link">
                            <i class="fas fa-users me-1"></i>Nh√¢n vi√™n
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/hang-hoa" class="nav-link">
                            <i class="fas fa-box me-1"></i>H√†ng h√≥a
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/khach-hang" class="nav-link">
                            <i class="fas fa-user-friends me-1"></i>Kh√°ch h√†ng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/nha-phan-phoi" class="nav-link">
                            <i class="fas fa-truck me-1"></i>Nh√† ph√¢n ph·ªëi
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a href="/settings" class="nav-link">
                            <i class="fas fa-cog me-1"></i>C√†i ƒë·∫∑t
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>Ng∆∞·ªùi d√πng
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/auth/change-password">
                                <i class="fas fa-key me-2"></i>ƒê·ªïi m·∫≠t kh·∫©u
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/auth/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4" style="padding-bottom: 80px;">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-box me-3"></i><span th:text="${pageTitle}">Qu·∫£n l√Ω H√†ng h√≥a</span></h1>
                <div>
                    <a href="/phieu-xuat/new" class="btn btn-success me-2">
                        <i class="fas fa-sign-out-alt me-2"></i>Xu·∫•t b√°n h√†ng h√≥a
                    </a>
                    <a href="/hang-hoa/new" class="btn btn-primary me-2">
                        <i class="fas fa-plus me-2"></i>Th√™m h√†ng h√≥a m·ªõi
                    </a>
                    <a href="/tra-hang" class="btn btn-warning me-2">
                        <i class="fas fa-undo me-2"></i>Tr·∫£ h√†ng
                    </a>
                    <a href="/hang-hoa/thong-ke" class="btn btn-info">
                        <i class="fas fa-chart-bar me-2"></i>Th·ªëng k√™
                    </a>
                </div>
        </div>

        <!-- Search Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-search me-2"></i>T√¨m ki·∫øm</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Combined Search Controls -->
                    <div class="col-md-2">
                        <label class="form-label">T√¨m ki·∫øm theo:</label>
                        <select id="searchType" class="form-select">
                            <option value="name">T√™n h√†ng h√≥a</option>
                            <option value="code">M√£ h√†ng h√≥a</option>
                            <option value="serial">S·ªë Serial</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">T·ª´ kh√≥a:</label>
                        <input type="text" id="searchKeyword" class="form-control" placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Danh s√°ch H√†ng h√≥a
                    <span class="badge bg-primary ms-2" id="totalCount" th:text="${#lists.size(danhSachHangHoa)}">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div th:if="${#lists.isEmpty(danhSachHangHoa)}" class="text-center py-5">
                    <i class="fas fa-box fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Ch∆∞a c√≥ h√†ng h√≥a n√†o</h4>
                    <a href="/hang-hoa/new" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Th√™m h√†ng h√≥a ƒë·∫ßu ti√™n
                    </a>
                </div>
                
                <div th:if="${!#lists.isEmpty(danhSachHangHoa)}">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="productsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ h√†ng h√≥a</th>
                                    <th>S·ªë Serial</th>
                                    <th>T√™n h√†ng h√≥a</th>
                                    <th>Lo·∫°i</th>
                                    <th>ƒê∆°n v·ªã t√≠nh</th>
                                    <th>Gi√° v·ªën</th>
                                    <th>Gi√° b√°n</th>
                                    <th>T·ªìn kho</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th width="150px">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr th:each="hangHoa, stat : ${danhSachHangHoa}" th:attr="data-id=${hangHoa.id}">
                                    <td th:text="${stat.count}">1</td>
                                    <td th:text="${hangHoa.maHangHoa}">HH001</td>
                                    <td th:text="${hangHoa.soSerial}">SN2024001</td>
                                    <td th:text="${hangHoa.tenHangHoa}">T√™n h√†ng h√≥a</td>
                                    <td th:text="${hangHoa.loaiHangHoa}">Lo·∫°i</td>
                                    <td th:text="${hangHoa.donViTinh}">C√°i</td>
                                    <td>
                                        <span th:if="${hangHoa.giaVon != null}" th:text="${#numbers.formatInteger(hangHoa.giaVon, 3, 'COMMA')} + ' ‚Ç´'">0 ‚Ç´</span>
                                        <span th:if="${hangHoa.giaVon == null}">-</span>
                                    </td>
                                    <td>
                                        <span th:if="${hangHoa.giaBan != null}" th:text="${#numbers.formatInteger(hangHoa.giaBan, 3, 'COMMA')} + ' ‚Ç´'">0 ‚Ç´</span>
                                        <span th:if="${hangHoa.giaBan == null}">-</span>
                                    </td>
                                    <td th:text="${hangHoa.soLuongTon}">0</td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${hangHoa.soLuongTon != null and hangHoa.soLuongTon > 0} ? 'bg-success' : 'bg-danger'"
                                              th:text="${hangHoa.soLuongTon != null and hangHoa.soLuongTon > 0} ? 'C√≤n h√†ng' : 'H·∫øt h√†ng'">Tr·∫°ng th√°i</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a th:href="@{'/hang-hoa/edit/' + ${hangHoa.id}}" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger btn-sm delete-btn" 
                                                    th:attr="data-id=${hangHoa.id}, data-name=${hangHoa.tenHangHoa}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
                        <span class="small text-muted" id="paginationInfo">Hi·ªÉn th·ªã 0-0 / 0</span>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="paginationPrev" disabled>Tr∆∞·ªõc</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="paginationNext" disabled>Ti·∫øp theo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Out of Stock Products Table (h·∫øt h√†ng) -->
        <div class="card mb-4" th:if="${!#lists.isEmpty(danhSachHetHang)}">
            <div class="card-header bg-danger">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-warning me-2"></i>Danh s√°ch H√†ng h√≥a H·∫øt h√†ng (T·ªìn kho = 0)
                    <span class="badge bg-warning text-dark ms-2" id="outOfStockCount" th:text="${#lists.size(danhSachHetHang)}">0</span>
                </h5>
            </div>

            <!-- Search Panel for Out of Stock Products -->
            <div class="card-header bg-light">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label"><small>T√¨m ki·∫øm theo:</small></label>
                        <select id="outOfStockSearchType" class="form-select form-select-sm">
                            <option value="name">T√™n h√†ng h√≥a</option>
                            <option value="code">M√£ h√†ng h√≥a</option>
                            <option value="serial">S·ªë Serial</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><small>T·ª´ kh√≥a:</small></label>
                        <input type="text" id="outOfStockSearchKeyword" class="form-control form-control-sm" placeholder="Nh·∫≠p t·ª´ kh√≥a...">
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="button" id="outOfStockResetSearch" class="btn btn-sm btn-secondary me-2">
                            <i class="fas fa-redo me-1"></i>X√≥a t√¨m ki·∫øm
                        </button>
                        <small class="text-muted">
                            <span id="outOfStockSearchResult"></span>
                        </small>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="outOfStockTable">
                        <thead class="table-dark">
                            <tr>
                                <th>STT</th>
                                <th>M√£ h√†ng h√≥a</th>
                                <th>S·ªë Serial</th>
                                <th>T√™n h√†ng h√≥a</th>
                                <th>Lo·∫°i</th>
                                <th>ƒê∆°n v·ªã t√≠nh</th>
                                <th>Gi√° v·ªën</th>
                                <th>Gi√° b√°n</th>
                                <th>Ng√†y nh·∫≠p</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th width="150px">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="outOfStockTableBody">
                            <tr th:each="hangHoa, stat : ${danhSachHetHang}" th:attr="data-id=${hangHoa.id}">
                                <td th:text="${stat.count}">1</td>
                                <td th:text="${hangHoa.maHangHoa}">HH001</td>
                                <td th:text="${hangHoa.soSerial}">SN2024001</td>
                                <td th:text="${hangHoa.tenHangHoa}">T√™n h√†ng h√≥a</td>
                                <td th:text="${hangHoa.loaiHangHoa}">Lo·∫°i</td>
                                <td th:text="${hangHoa.donViTinh}">C√°i</td>
                                <td>
                                    <span th:if="${hangHoa.giaVon != null}" th:text="${#numbers.formatInteger(hangHoa.giaVon, 3, 'COMMA')} + ' ‚Ç´'">0 ‚Ç´</span>
                                    <span th:if="${hangHoa.giaVon == null}">-</span>
                                </td>
                                <td>
                                    <span th:if="${hangHoa.giaBan != null}" th:text="${#numbers.formatInteger(hangHoa.giaBan, 3, 'COMMA')} + ' ‚Ç´'">0 ‚Ç´</span>
                                    <span th:if="${hangHoa.giaBan == null}">-</span>
                                </td>
                                <td>
                                    <span th:if="${hangHoa.ngayNhap != null}" th:text="${#temporals.format(hangHoa.ngayNhap, 'dd/MM/yyyy')}">01/01/2024</span>
                                    <span th:if="${hangHoa.ngayNhap == null}">-</span>
                                </td>
                                <td>
                                    <span class="badge bg-danger">H·∫øt h√†ng</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/hang-hoa/edit/' + ${hangHoa.id}}" class="btn btn-outline-primary btn-sm" title="S·ª≠a h√†ng h√≥a">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Th√¥ng tin:</strong> Danh s√°ch n√†y hi·ªÉn th·ªã c√°c h√†ng h√≥a c√≥ t·ªìn kho b·∫±ng 0, s·∫Øp x·∫øp theo ng√†y nh·∫≠p t·ª´ g·∫ßn nh·∫•t ƒë·∫øn xa nh·∫•t.
                    </div>
                    <span class="small text-muted" id="outOfStockPaginationInfo">Hi·ªÉn th·ªã 0-0 / 0</span>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="outOfStockPaginationPrev" disabled>Tr∆∞·ªõc</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="outOfStockPaginationNext" disabled>Ti·∫øp theo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i>X√°c nh·∫≠n x√≥a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√†ng h√≥a "<span id="deleteItemName"></span>"?</p>
                    <p class="text-danger"><small>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">
                        <i class="fas fa-trash me-1"></i>X√≥a
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ REAL-TIME UPDATE CONFIGURATION ============
        const REAL_TIME_UPDATE_ENABLED = true; // B·∫≠t t√≠nh nƒÉng c·∫≠p nh·∫≠t th·ªùi gian th·ª±c
        const UPDATE_INTERVAL_MS = 5000; // C·∫≠p nh·∫≠t m·ªói 5 gi√¢y
        let updateTimer = null;

        // Global variables
        const ROWS_PER_PAGE = 15;
        const OUT_OF_STOCK_ROWS_PER_PAGE = 10;
        let currentPage = 1;
        let currentOutOfStockPage = 1;
        let tableRows = [];
        let outOfStockRows = [];
        let currentDeleteId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            tableRows = Array.from(document.querySelectorAll('#productsTableBody tr'));
            tableRows.forEach(row => row.dataset.matchesSearch = 'true');
            
            outOfStockRows = Array.from(document.querySelectorAll('#outOfStockTableBody tr'));
            outOfStockRows.forEach(row => row.dataset.matchesSearch = 'true');
            
            initializeEventListeners();
            updateSelectedCount();
            updateSearchPlaceholder();
            updatePagination(1);
            updateOutOfStockPagination(1);
            updateOutOfStockSearchResult();

            // Start real-time updates if enabled
            if (REAL_TIME_UPDATE_ENABLED) {
                console.log('üîÑ Real-time product updates enabled (every ' + UPDATE_INTERVAL_MS + 'ms)');
                startRealTimeUpdates();
            }
        });

        // H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu th·ªùi gian th·ª±c t·ª´ server
        function startRealTimeUpdates() {
            // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
            fetchProductListAndUpdate();
            
            // Sau ƒë√≥ c·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥
            updateTimer = setInterval(fetchProductListAndUpdate, UPDATE_INTERVAL_MS);
        }

        // D·ª´ng c·∫≠p nh·∫≠t th·ªùi gian th·ª±c
        function stopRealTimeUpdates() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
                console.log('‚èπÔ∏è Real-time updates stopped');
            }
        }

        // L·∫•y d·ªØ li·ªáu t·ª´ API v√† c·∫≠p nh·∫≠t b·∫£ng
        function fetchProductListAndUpdate() {
            fetch('/hang-hoa/api/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTableWithNewData(data.inStock, data.outOfStock);
                    } else {
                        console.error('‚ùå API error:', data.error);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error fetching product list:', error);
                });
        }

        // C·∫≠p nh·∫≠t b·∫£ng v·ªõi d·ªØ li·ªáu m·ªõi t·ª´ server
        function updateTableWithNewData(inStockData, outOfStockData) {
            updateInStockTable(inStockData);
            updateOutOfStockTable(outOfStockData);
        }

        // C·∫≠p nh·∫≠t b·∫£ng h√†ng h√≥a c√≤n t·ªìn
        function updateInStockTable(productsData) {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;

            // T·∫°o b·∫£n ƒë·ªì ID -> HTML row t·ª´ d·ªØ li·ªáu hi·ªán t·∫°i
            const currentRows = {};
            tableRows.forEach(row => {
                const rowId = row.getAttribute('data-id');
                if (rowId) {
                    currentRows[rowId] = row;
                }
            });

            // T·∫°o b·∫£n ƒë·ªì ID -> d·ªØ li·ªáu t·ª´ server
            const newRowsMap = {};
            productsData.forEach(product => {
                newRowsMap[product.id] = product;
            });

            // Xo√° c√°c h√†ng kh√¥ng c√≤n trong d·ªØ li·ªáu m·ªõi
            Object.keys(currentRows).forEach(rowId => {
                if (!newRowsMap[rowId]) {
                    const row = currentRows[rowId];
                    row.style.display = 'none';
                    setTimeout(() => row.remove(), 300);
                }
            });

            // C·∫≠p nh·∫≠t ho·∫∑c th√™m c√°c h√†ng
            let rowNumber = 0;
            productsData.forEach((product, index) => {
                rowNumber++;
                const rowId = String(product.id);
                let row = currentRows[rowId];

                if (row) {
                    // C·∫≠p nh·∫≠t h√†ng hi·ªán c√≥
                    updateRowData(row, product, rowNumber);
                } else {
                    // Th√™m h√†ng m·ªõi
                    const newRow = createProductRow(product, rowNumber);
                    tbody.appendChild(newRow);
                    tableRows.push(newRow);
                    currentRows[rowId] = newRow;
                    
                    // Highlight d√≤ng m·ªõi
                    newRow.style.opacity = '0.5';
                    setTimeout(() => {
                        newRow.style.transition = 'opacity 0.5s';
                        newRow.style.opacity = '1';
                    }, 100);
                }
            });

            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng t·ªïng c·ªông
            const totalBadge = document.getElementById('totalCount');
            if (totalBadge) {
                totalBadge.textContent = productsData.length;
            }

            // C·∫≠p nh·∫≠t ph√¢n trang n·∫øu c·∫ßn
            updatePagination(currentPage);
        }

        // C·∫≠p nh·∫≠t b·∫£ng h√†ng h√≥a h·∫øt t·ªìn
        function updateOutOfStockTable(productsData) {
            const tbody = document.getElementById('outOfStockTableBody');
            if (!tbody) return;

            // T·∫°o b·∫£n ƒë·ªì ID -> HTML row t·ª´ d·ªØ li·ªáu hi·ªán t·∫°i
            const currentRows = {};
            outOfStockRows.forEach(row => {
                const rowId = row.getAttribute('data-id');
                if (rowId) {
                    currentRows[rowId] = row;
                }
            });

            // T·∫°o b·∫£n ƒë·ªì ID -> d·ªØ li·ªáu t·ª´ server
            const newRowsMap = {};
            productsData.forEach(product => {
                newRowsMap[product.id] = product;
            });

            // Xo√° c√°c h√†ng kh√¥ng c√≤n trong d·ªØ li·ªáu m·ªõi
            Object.keys(currentRows).forEach(rowId => {
                if (!newRowsMap[rowId]) {
                    const row = currentRows[rowId];
                    row.style.display = 'none';
                    setTimeout(() => row.remove(), 300);
                }
            });

            // C·∫≠p nh·∫≠t ho·∫∑c th√™m c√°c h√†ng
            let rowNumber = 0;
            productsData.forEach((product, index) => {
                rowNumber++;
                const rowId = String(product.id);
                let row = currentRows[rowId];

                if (row) {
                    // C·∫≠p nh·∫≠t h√†ng hi·ªán c√≥
                    updateOutOfStockRowData(row, product, rowNumber);
                } else {
                    // Th√™m h√†ng m·ªõi
                    const newRow = createOutOfStockRow(product, rowNumber);
                    newRow.dataset.matchesSearch = 'true';
                    tbody.appendChild(newRow);
                    outOfStockRows.push(newRow);
                    currentRows[rowId] = newRow;
                }
            });

            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng t·ªïng c·ªông
            const countBadge = document.getElementById('outOfStockCount');
            if (countBadge) {
                countBadge.textContent = productsData.length;
            }

            // C·∫≠p nh·∫≠t ph√¢n trang
            updateOutOfStockPagination(currentOutOfStockPage);
            updateOutOfStockSearchResult();
        }

        // C·∫≠p nh·∫≠t d·ªØ li·ªáu c·ªßa m·ªôt h√†ng t·ªìn kho
        function updateRowData(row, product, rowNumber) {
            const cells = row.querySelectorAll('td');
            if (cells.length < 10) return;

            const oldQuantity = parseInt(cells[8]?.textContent || '0');
            const newQuantity = product.soLuongTon || 0;

            // C·∫≠p nh·∫≠t c√°c √¥ (indexes ƒë√£ d·ªãch do x√≥a checkbox column)
            cells[0].textContent = rowNumber;
            cells[1].textContent = product.maHangHoa || '';
            cells[2].textContent = product.soSerial || '';
            cells[3].textContent = product.tenHangHoa || '';
            cells[4].textContent = product.loaiHangHoa || '';
            cells[5].textContent = product.donViTinh || '';
            cells[6].textContent = product.giaVon ? formatNumber(product.giaVon) + ' ‚Ç´' : '-';
            cells[7].textContent = product.giaBan ? formatNumber(product.giaBan) + ' ‚Ç´' : '-';
            cells[8].textContent = newQuantity;

            // C·∫≠p nh·∫≠t badge tr·∫°ng th√°i
            const badge = cells[9]?.querySelector('.badge');
            if (badge) {
                if (newQuantity > 0) {
                    badge.className = 'badge bg-success';
                    badge.textContent = 'C√≤n h√†ng';
                } else {
                    badge.className = 'badge bg-danger';
                    badge.textContent = 'H·∫øt h√†ng';
                }
            }

            // Highlight n·∫øu s·ªë l∆∞·ª£ng thay ƒë·ªïi
            if (oldQuantity !== newQuantity) {
                cells[8].style.backgroundColor = newQuantity > oldQuantity ? '#d4edda' : '#f8d7da';
                setTimeout(() => {
                    cells[8].style.transition = 'background-color 0.5s';
                    cells[8].style.backgroundColor = 'transparent';
                }, 1500);
            }
        }

        // C·∫≠p nh·∫≠t d·ªØ li·ªáu c·ªßa m·ªôt h√†ng h·∫øt t·ªìn
        function updateOutOfStockRowData(row, product, rowNumber) {
            const cells = row.querySelectorAll('td');
            if (cells.length < 10) return;

            cells[0].textContent = rowNumber;
            cells[1].textContent = product.maHangHoa || '';
            cells[2].textContent = product.soSerial || '';
            cells[3].textContent = product.tenHangHoa || '';
            cells[4].textContent = product.loaiHangHoa || '';
            cells[5].textContent = product.donViTinh || '';
            cells[6].textContent = product.giaVon ? formatNumber(product.giaVon) + ' ‚Ç´' : '-';
            cells[7].textContent = product.giaBan ? formatNumber(product.giaBan) + ' ‚Ç´' : '-';
            if (product.ngayNhap) {
                cells[8].textContent = new Date(product.ngayNhap).toLocaleDateString('vi-VN');
            } else {
                cells[8].textContent = '-';
            }
        }

        // T·∫°o h√†ng s·∫£n ph·∫©m m·ªõi
        function createProductRow(product, rowNumber) {
            const row = document.createElement('tr');
            row.setAttribute('data-id', product.id);
            row.innerHTML = `
                <td>${rowNumber}</td>
                <td>${product.maHangHoa || ''}</td>
                <td>${product.soSerial || ''}</td>
                <td>${product.tenHangHoa || ''}</td>
                <td>${product.loaiHangHoa || ''}</td>
                <td>${product.donViTinh || ''}</td>
                <td>${product.giaVon ? formatNumber(product.giaVon) + ' ‚Ç´' : '-'}</td>
                <td>${product.giaBan ? formatNumber(product.giaBan) + ' ‚Ç´' : '-'}</td>
                <td>${product.soLuongTon || 0}</td>
                <td><span class="badge ${product.soLuongTon > 0 ? 'bg-success' : 'bg-danger'}">${product.soLuongTon > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng'}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="/hang-hoa/edit/${product.id}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-sm delete-btn" data-id="${product.id}" data-name="${product.tenHangHoa}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;

            // Th√™m event listener cho n√∫t x√≥a
            row.querySelector('.delete-btn').addEventListener('click', function() {
                currentDeleteId = this.dataset.id;
                document.getElementById('deleteItemName').textContent = this.dataset.name;
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            });

            return row;
        }

        // T·∫°o h√†ng h·∫øt t·ªìn m·ªõi
        function createOutOfStockRow(product, rowNumber) {
            const row = document.createElement('tr');
            row.setAttribute('data-id', product.id);
            const dateStr = product.ngayNhap ? new Date(product.ngayNhap).toLocaleDateString('vi-VN') : '-';
            row.innerHTML = `
                <td>${rowNumber}</td>
                <td>${product.maHangHoa || ''}</td>
                <td>${product.soSerial || ''}</td>
                <td>${product.tenHangHoa || ''}</td>
                <td>${product.loaiHangHoa || ''}</td>
                <td>${product.donViTinh || ''}</td>
                <td>${product.giaVon ? formatNumber(product.giaVon) + ' ‚Ç´' : '-'}</td>
                <td>${product.giaBan ? formatNumber(product.giaBan) + ' ‚Ç´' : '-'}</td>
                <td>${dateStr}</td>
                <td><span class="badge bg-danger">H·∫øt h√†ng</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="/hang-hoa/edit/${product.id}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                </td>
            `;

            return row;
        }

        // H√†m format s·ªë th√†nh chu·ªói v·ªõi 3 ch·ªØ s·ªë
        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(num);
        }

        function initializeEventListeners() {
            const selectAll = document.getElementById('selectAll');
            const selectAllOutOfStock = document.getElementById('selectAllOutOfStock');
            const searchTypeSelect = document.getElementById('searchType');
            const searchKeywordInput = document.getElementById('searchKeyword');
            const confirmDeleteBtn = document.getElementById('confirmDelete');
            const prevBtn = document.getElementById('paginationPrev');
            const nextBtn = document.getElementById('paginationNext');
            const outOfStockPrevBtn = document.getElementById('outOfStockPaginationPrev');
            const outOfStockNextBtn = document.getElementById('outOfStockPaginationNext');

            // Search functionality
            if (searchTypeSelect) {
                searchTypeSelect.addEventListener('change', function() {
                    updateSearchPlaceholder();
                    filterTable();
                });
            }
            if (searchKeywordInput) {
                searchKeywordInput.addEventListener('input', filterTable);
            }

            // Delete buttons in table
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentDeleteId = this.dataset.id;
                    document.getElementById('deleteItemName').textContent = this.dataset.name;
                    new bootstrap.Modal(document.getElementById('deleteModal')).show();
                });
            });

            // Confirm delete
            confirmDeleteBtn?.addEventListener('click', function() {
                if (currentDeleteId) {
                    window.location.href = `/hang-hoa/${currentDeleteId}/delete`;
                }
            });

            if (prevBtn) {
                prevBtn.addEventListener('click', () => updatePagination(currentPage - 1));
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => updatePagination(currentPage + 1));
            }

            // Out of stock pagination
            if (outOfStockPrevBtn) {
                outOfStockPrevBtn.addEventListener('click', () => updateOutOfStockPagination(currentOutOfStockPage - 1));
            }
            if (outOfStockNextBtn) {
                outOfStockNextBtn.addEventListener('click', () => updateOutOfStockPagination(currentOutOfStockPage + 1));
            }

            // Out of Stock Search functionality
            const outOfStockSearchType = document.getElementById('outOfStockSearchType');
            const outOfStockSearchKeyword = document.getElementById('outOfStockSearchKeyword');
            const outOfStockResetSearch = document.getElementById('outOfStockResetSearch');

            if (outOfStockSearchType) {
                outOfStockSearchType.addEventListener('change', filterOutOfStockTable);
            }
            if (outOfStockSearchKeyword) {
                outOfStockSearchKeyword.addEventListener('input', filterOutOfStockTable);
            }
            if (outOfStockResetSearch) {
                outOfStockResetSearch.addEventListener('click', function() {
                    if (outOfStockSearchType) {
                        outOfStockSearchType.value = 'name';
                    }
                    if (outOfStockSearchKeyword) {
                        outOfStockSearchKeyword.value = '';
                    }
                    filterOutOfStockTable();
                });
            }
        }

        function updateSelectedCount() {
            // Checkboxes removed from table
        }

        function updateSearchPlaceholder() {
            const searchTypeElement = document.getElementById('searchType');
            const searchKeyword = document.getElementById('searchKeyword');
            if (!searchTypeElement || !searchKeyword) {
                return;
            }
            const searchType = searchTypeElement.value;

            switch(searchType) {
                case 'name':
                    searchKeyword.placeholder = 'Nh·∫≠p t√™n h√†ng h√≥a...';
                    break;
                case 'code':
                    searchKeyword.placeholder = 'Nh·∫≠p m√£ h√†ng h√≥a...';
                    break;
                case 'serial':
                    searchKeyword.placeholder = 'Nh·∫≠p s·ªë serial...';
                    break;
            }
        }

        function filterTable() {
            if (!tableRows.length) {
                updatePagination(1);
                return;
            }

            const searchTypeElement = document.getElementById('searchType');
            const searchKeywordInput = document.getElementById('searchKeyword');
            if (!searchTypeElement || !searchKeywordInput) {
                return;
            }

            const searchType = searchTypeElement.value;
            const keyword = searchKeywordInput.value.trim().toLowerCase();

            tableRows.forEach(row => {
                let searchValue = '';
                switch(searchType) {
                    case 'name':
                        searchValue = (row.cells[3]?.textContent || '').toLowerCase();
                        break;
                    case 'code':
                        searchValue = (row.cells[1]?.textContent || '').toLowerCase();
                        break;
                    case 'serial':
                        searchValue = (row.cells[2]?.textContent || '').toLowerCase();
                        break;
                    default:
                        searchValue = '';
                        break;
                }
                const matches = keyword === '' || searchValue.includes(keyword);
                row.dataset.matchesSearch = matches ? 'true' : 'false';
            });

            updatePagination(1);
        }

        function filterOutOfStockTable() {
            if (!outOfStockRows.length) {
                updateOutOfStockPagination(1);
                const searchResultSpan = document.getElementById('outOfStockSearchResult');
                if (searchResultSpan) {
                    searchResultSpan.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                }
                return;
            }

            const searchTypeElement = document.getElementById('outOfStockSearchType');
            const searchKeywordInput = document.getElementById('outOfStockSearchKeyword');
            if (!searchTypeElement || !searchKeywordInput) {
                return;
            }

            const searchType = searchTypeElement.value;
            const keyword = searchKeywordInput.value.trim().toLowerCase();

            outOfStockRows.forEach(row => {
                let searchValue = '';
                switch(searchType) {
                    case 'name':
                        searchValue = (row.cells[3]?.textContent || '').toLowerCase();
                        break;
                    case 'code':
                        searchValue = (row.cells[1]?.textContent || '').toLowerCase();
                        break;
                    case 'serial':
                        searchValue = (row.cells[2]?.textContent || '').toLowerCase();
                        break;
                    default:
                        searchValue = '';
                        break;
                }
                const matches = keyword === '' || searchValue.includes(keyword);
                row.dataset.matchesSearch = matches ? 'true' : 'false';
            });

            updateOutOfStockPagination(1);
            updateOutOfStockSearchResult();
        }

        function updateOutOfStockSearchResult() {
            const searchResultSpan = document.getElementById('outOfStockSearchResult');
            const searchKeywordInput = document.getElementById('outOfStockSearchKeyword');
            if (!searchResultSpan) {
                return;
            }

            const keyword = searchKeywordInput ? searchKeywordInput.value.trim() : '';
            const matchingRows = outOfStockRows.filter(row => row.dataset.matchesSearch !== 'false');
            const totalRows = outOfStockRows.length;
            
            if (keyword) {
                searchResultSpan.textContent = `T√¨m th·∫•y: ${matchingRows.length}/${totalRows}`;
            } else {
                searchResultSpan.textContent = `T·ªïng: ${totalRows}`;
            }
        }

        function updatePagination(page = currentPage) {
            const paginationInfo = document.getElementById('paginationInfo');
            const prevBtn = document.getElementById('paginationPrev');
            const nextBtn = document.getElementById('paginationNext');

            if (!tableRows.length) {
                if (paginationInfo) {
                    paginationInfo.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                }
                prevBtn?.setAttribute('disabled', 'disabled');
                nextBtn?.setAttribute('disabled', 'disabled');
                updateTotalBadge(0);
                return;
            }

            const matchingRows = tableRows.filter(row => row.dataset.matchesSearch !== 'false');
            const totalRows = matchingRows.length;
            const totalPages = totalRows === 0 ? 1 : Math.ceil(totalRows / ROWS_PER_PAGE);
            currentPage = totalRows === 0 ? 1 : Math.min(Math.max(page, 1), totalPages);
            const startIndex = (currentPage - 1) * ROWS_PER_PAGE;
            const endIndex = startIndex + ROWS_PER_PAGE;

            tableRows.forEach(row => {
                row.style.display = 'none';
            });

            matchingRows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = '';
                }
            });

            if (paginationInfo) {
                if (totalRows === 0) {
                    paginationInfo.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                } else {
                    paginationInfo.textContent = `Hi·ªÉn th·ªã ${startIndex + 1}-${Math.min(endIndex, totalRows)} / ${totalRows}`;
                }
            }

            if (prevBtn) {
                prevBtn.disabled = totalRows === 0 || currentPage <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = totalRows === 0 || currentPage >= totalPages;
            }

            updateTotalBadge(totalRows);
            updateSelectedCount();
        }

        function updateTotalBadge(matchingCount) {
            const totalBadge = document.getElementById('totalCount');
            const searchKeywordInput = document.getElementById('searchKeyword');
            if (!totalBadge) {
                return;
            }
            const keyword = searchKeywordInput ? searchKeywordInput.value.trim() : '';
            if (keyword) {
                totalBadge.textContent = `${matchingCount}/${tableRows.length}`;
            } else {
                totalBadge.textContent = tableRows.length;
            }
        }

        function showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        function updateOutOfStockPagination(page = currentOutOfStockPage) {
            const paginationInfo = document.getElementById('outOfStockPaginationInfo');
            const prevBtn = document.getElementById('outOfStockPaginationPrev');
            const nextBtn = document.getElementById('outOfStockPaginationNext');

            if (!outOfStockRows.length) {
                if (paginationInfo) {
                    paginationInfo.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                }
                prevBtn?.setAttribute('disabled', 'disabled');
                nextBtn?.setAttribute('disabled', 'disabled');
                return;
            }

            // Filter rows based on search
            const matchingRows = outOfStockRows.filter(row => row.dataset.matchesSearch !== 'false');
            const totalRows = matchingRows.length;
            const totalPages = totalRows === 0 ? 1 : Math.ceil(totalRows / OUT_OF_STOCK_ROWS_PER_PAGE);
            currentOutOfStockPage = totalRows === 0 ? 1 : Math.min(Math.max(page, 1), totalPages);
            const startIndex = (currentOutOfStockPage - 1) * OUT_OF_STOCK_ROWS_PER_PAGE;
            const endIndex = startIndex + OUT_OF_STOCK_ROWS_PER_PAGE;

            // Hide all rows
            outOfStockRows.forEach(row => {
                row.style.display = 'none';
            });

            // Show rows for current page
            matchingRows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = '';
                }
            });

            if (paginationInfo) {
                if (totalRows === 0) {
                    paginationInfo.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                } else {
                    paginationInfo.textContent = `Hi·ªÉn th·ªã ${startIndex + 1}-${Math.min(endIndex, totalRows)} / ${totalRows}`;
                }
            }

            if (prevBtn) {
                prevBtn.disabled = totalRows === 0 || currentOutOfStockPage <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = totalRows === 0 || currentOutOfStockPage >= totalPages;
            }
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>